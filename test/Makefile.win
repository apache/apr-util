# PROGRAMS includes all test programs built on this platform.
# STDTEST_PORTABLE
#   test programs invoked via standard user interface, run on all platforms
# STDTEST_NONPORTABLE
#   test programs invoked via standard user interface, not portable
# OTHER_PROGRAMS
#   programs such as sendfile, that have to be invoked in a special sequence
#   or with special parameters

!IFNDEF MODEL
MODEL=dynamic
!ENDIF

!IFNDEF OUTDIR
!IF "$(MODEL)" == "static"
OUTDIR=LibR
!ELSE
OUTDIR=Release
!ENDIF

!IF [$(COMSPEC) /c cl /nologo /? | find "x64" >NUL ] == 0
OUTDIR=x64\$(OUTDIR)
!ENDIF
!ENDIF

!IF !EXIST("$(OUTDIR)\.")
!IF ([$(COMSPEC) /C mkdir $(OUTDIR)] == 0)
!ENDIF
!ENDIF

!IFNDEF INTDIR
INTDIR=$(OUTDIR)
!ELSE
!IF !EXIST("$(INTDIR)\.")
!IF ([$(COMSPEC) /C mkdir $(INTDIR)] == 0)
!ENDIF
!ENDIF
!ENDIF

!MESSAGE Building tests into $(OUTDIR) for $(MODEL)

ALL_TESTS = $(INTDIR)\teststrmatch.obj $(INTDIR)\testuri.obj \
	$(INTDIR)\testuuid.obj $(INTDIR)\testutil.obj \
	$(INTDIR)\testbuckets.obj $(INTDIR)\testpass.obj \
	$(INTDIR)\testmd4.obj $(INTDIR)\testmd5.obj \
	$(INTDIR)\testldap.obj $(INTDIR)\testdbd.obj \
	$(OUTDIR)\testdbm.obj $(OUTDIR)\testreslist.obj \
	$(OUTDIR)\testxml.obj $(OUTDIR)\testqueue.obj \
	$(OUTDIR)\testrmm.obj $(OUTDIR)\testxlate.obj \
	$(OUTDIR)\testdate.obj

CLEAN_DATA = manyfile.bin testfile.txt data\sqlite*.db

CLEAN_BUILDDIRS = Debug Release LibD LibR 9x x64

TEST_SUBDIRS = internal

PROGRAMS = $(OUTDIR)\testall.exe \

OTHER_PROGRAMS = $(OUTDIR)\dbd.exe

# bring in rules.mk for standard functionality
ALL: $(PROGRAMS)

CL = cl.exe
LD = link.exe 

APR_PATH = ..\..\apr
API_PATH = ..\..\apr-iconv

!IF "$(MODEL)" == "static"
PROGRAM_DEPENDENCIES = \
	$(APR_PATH)\$(OUTDIR)\apr-1.lib \
	$(API_PATH)\$(OUTDIR)\apriconv-1.lib \
	..\$(OUTDIR)\aprutil-1.lib 
STATIC_CFLAGS = /D APR_DECLARE_STATIC /D APU_DECLARE_STATIC
!ELSE
PROGRAM_DEPENDENCIES = \
	$(APR_PATH)\$(OUTDIR)\libapr-1.lib \
	$(API_PATH)\$(OUTDIR)\libapriconv-1.lib \
	..\$(OUTDIR)\libaprutil-1.lib 
STATIC_CFLAGS = 
!ENDIF

!IFDEF _DEBUG
DEBUG_CFLAGS = /MDd
!ELSE
DEBUG_CFLAGS = /MD 
!ENDIF

INCLUDES=/I "../include" /I "$(API_PATH)/include" /I "$(APR_PATH)/include"

CFLAGS = /nologo /c /W3 /Gm /EHsc /Zi /Od $(INCLUDES) \
	 $(STATIC_CFLAGS) $(DEBUG_CFLAGS) /D "BINPATH=$(OUTDIR:\=/)" \
	 /D _DEBUG /D WIN32 /Fo"$(INTDIR)/" /FD

LD_LIBS = kernel32.lib advapi32.lib ws2_32.lib wsock32.lib \
	  ole32.lib shell32.lib rpcrt4.lib wldap32.lib

LDFLAGS = /nologo /debug /subsystem:console /incremental:no 
SHLDFLAGS = /nologo /dll /debug /subsystem:windows /incremental:no

.c{$(INTDIR)}.obj::
	$(CL) $(CFLAGS) -c $< -Fd$(INTDIR)\ $(INCLUDES)

# PROGRAMS;

$(OUTDIR)\testall.exe: $(ALL_TESTS) $(INTDIR)\abts.obj $(PROGRAM_DEPENDENCIES)
	$(LD) $(LDFLAGS) /out:"$@" $** $(LD_LIBS)
	@if exist "$@.manifest" \
	    mt.exe -manifest "$@.manifest" -outputresource:$@;1

$(OUTDIR)\testdbm.exe: $(INTDIR)\testdbm.obj $(PROGRAM_DEPENDENCIES)
	$(LD) $(LDFLAGS) /out:"$@" $** $(LD_LIBS)
	@if exist "$@.manifest" \
	    mt.exe -manifest "$@.manifest" -outputresource:$@;1

$(OUTDIR)\dbd.exe: $(INTDIR)\dbd.obj $(PROGRAM_DEPENDENCIES)
	$(LD) $(LDFLAGS) /out:"$@" $** $(LD_LIBS)
	@if exist "$@.manifest" \
	    mt.exe -manifest "$@.manifest" -outputresource:$@;1

$(OUTDIR)\testdbd.exe: $(INTDIR)\testdbd.obj $(PROGRAM_DEPENDENCIES)
	$(LD) $(LDFLAGS) /out:"$@" $** $(LD_LIBS)
	@if exist "$@.manifest" \
	    mt.exe -manifest "$@.manifest" -outputresource:$@;1

$(OUTDIR)\testdate.exe: $(INTDIR)\testdate.obj $(PROGRAM_DEPENDENCIES)
	$(LD) $(LDFLAGS) /out:"$@" $** $(LD_LIBS)
	@if exist "$@.manifest" \
	    mt.exe -manifest "$@.manifest" -outputresource:$@;1

$(OUTDIR)\testxml.exe: $(INTDIR)\testxml.obj $(PROGRAM_DEPENDENCIES)
	$(LD) $(LDFLAGS) /out:"$@" $** $(LD_LIBS)
	@if exist "$@.manifest" \
	    mt.exe -manifest "$@.manifest" -outputresource:$@;1

$(OUTDIR)\testrmm.exe: $(INTDIR)\testrmm.obj $(PROGRAM_DEPENDENCIES)
	$(LD) $(LDFLAGS) /out:"$@" $** $(LD_LIBS)
	@if exist "$@.manifest" \
	    mt.exe -manifest "$@.manifest" -outputresource:$@;1

$(OUTDIR)\testreslist.exe: $(INTDIR)\testreslist.obj $(PROGRAM_DEPENDENCIES)
	$(LD) $(LDFLAGS) /out:"$@" $** $(LD_LIBS)
	@if exist "$@.manifest" \
	    mt.exe -manifest "$@.manifest" -outputresource:$@;1

$(OUTDIR)\testqueue.exe: $(INTDIR)\testqueue.obj $(PROGRAM_DEPENDENCIES)
	$(LD) $(LDFLAGS) /out:"$@" $** $(LD_LIBS)
	@if exist "$@.manifest" \
	    mt.exe -manifest "$@.manifest" -outputresource:$@;1

$(OUTDIR)\testxlate.exe: $(INTDIR)\testxlate.obj $(PROGRAM_DEPENDENCIES)
	$(LD) $(LDFLAGS) /out:"$@" $** $(LD_LIBS)
	@if exist "$@.manifest" \
	    mt.exe -manifest "$@.manifest" -outputresource:$@;1


cleandata:
	@for %f in ($(CLEAN_DATA)) do @if EXIST %f del /f %f

clean: cleandata
	@if EXIST $(INTDIR)\. rmdir /s /q $(INTDIR)
	@if EXIST $(OUTDIR)\. rmdir /s /q $(OUTDIR)
	@for %d in ($(TEST_SUBDIRS)) do \
	    %COMSPEC% /c "cd %%d && $(MAKE) -f Makefile.win clean" \

cleanall: 
	@for %d in ($(CLEAN_BUILDDIRS) $(INTDIR) $(OUTDIR)) do \
	    @if EXIST %d\. rmdir /s /q %d
	@for %d in ($(TEST_SUBDIRS)) do \
	    %COMSPEC% /c "cd %%d & $(MAKE) -f Makefile.win cleanall" \


PATH=$(OUTDIR);..\$(OUTDIR);$(API_PATH)\$(OUTDIR);$(APR_PATH)\$(OUTDIR);$(PATH)
APR_ICONV1_PATH=$(API_PATH)\$(OUTDIR)\iconv

check: $(TESTALL_COMPONENTS) $(STDTEST_PORTABLE) $(STDTEST_NONPORTABLE)
	@for %p in ($(PROGRAMS)) do @( \
	    echo Testing %p && %p || echo %p failed \
	)

checkall: check
	@for %d in ($(TEST_SUBDIRS)) do \
	    %COMSPEC% /c "cd %%d && $(MAKE) -f Makefile.win check" \

# DO NOT REMOVE
